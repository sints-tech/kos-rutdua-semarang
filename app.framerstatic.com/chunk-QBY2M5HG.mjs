import{a as C,b as E,d as A}from"https://app.framerstatic.com/chunk-XOHSX3RM.mjs";import{c as k,d as U,e as D,g as L,h as w,o as M,r as b,u as P}from"https://app.framerstatic.com/chunk-BY4UT6YX.mjs";import{b as v}from"https://app.framerstatic.com/chunk-4QYPAPBC.mjs";import{n as h}from"https://app.framerstatic.com/chunk-N6T5M2U2.mjs";import{f as I}from"https://app.framerstatic.com/chunk-JRE74LV4.mjs";import{a as R}from"https://app.framerstatic.com/chunk-FI7WGJHP.mjs";import{i as y}from"https://app.framerstatic.com/chunk-XFCQREKZ.mjs";import{l as p,u as g}from"https://app.framerstatic.com/chunk-IZV4HDYJ.mjs";import{a}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{a as T}from"https://app.framerstatic.com/chunk-LQILWJHN.mjs";import{j as o}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";var u=g("RemoteConnection"),j=1e3,f=class extends v{constructor(e){super();o(this,"isReconnect",!1);o(this,"messageQueue",[]);o(this,"baseURL");o(this,"socket");o(this,"stats");this.baseURL=A(e)}createPingInterval(e,t){return setInterval(()=>{if(a(this.socket===e,"Invalid socket"),a(this.stats===t,"Invalid stats"),performance.now()-t.lastSend()<j||t.pendingCount("ping")>0)return;let n="ping {}";e.send(n),t.sent("ping",n)},j)}connect(e){if(this.socket)return;let t=new URL(this.baseURL);t.searchParams.set("v",String(U)),t.searchParams.set("tunnel",R()??""),t.searchParams.set("treeSchema",String(h)),t.searchParams.set("treeVersion",String(e));let n=new WebSocket(t),s=new k;this.socket=n,this.stats=s,u.debug("Connecting:",n.url);let r;n.addEventListener("open",()=>{a(this.socket===n,"Invalid socket"),a(this.stats===s,"Invalid stats"),u.debug("Connected:",n.url),r=this.createPingInterval(n,s),this.emit("connect",this.isReconnect),this.isReconnect=!0,this.flushMessageQueue(n,s)}),n.addEventListener("message",c=>{a(this.socket===n,"Invalid socket"),a(this.stats===s,"Invalid stats");let d=c.data,m=w(d);if(s.received(d),m.type==="ack")return s.acked();m.type==="redirect"&&(this.baseURL=m.value.url),u.trace("Received:",m),this.emit("message",m)}),n.addEventListener("close",c=>{a(this.socket===n,"Invalid socket"),a(this.stats===s,"Invalid stats"),clearInterval(r);let d=L(c);u.debug("Disconnected:",d),this.socket=void 0,this.stats=void 0,this.emit("disconnect",d)})}disconnect(){this.socket?.close()}flushMessageQueue(e,t){if(e.readyState===WebSocket.OPEN){for(let{type:n,value:s}of this.messageQueue)try{let r=JSON.stringify(s),c=`${n} ${r}`;e.send(c),t.sent(n,c)}catch(r){u.warn("Error sending:",n,r)}this.messageQueue.length=0}}send(e){this.messageQueue.push(e),this.socket&&this.stats&&this.flushMessageQueue(this.socket,this.stats)}onMessage(e){return this.on("message",e),()=>{this.off("message",e)}}};var S=class extends v{constructor(e,t){super();this.timeline=e;this.projectId=t;o(this,"treeSync");o(this,"remoteTreeUpdates",[]);o(this,"documentLoader");this.treeSync=new P(this.timeline.tree,0,this.timeline),this.treeSync.waitingForTree=!0}handleTreeMessage(e){if(e.type!=="init")return;let t=T();this.treeSync.handleInit(e.data.treeVersion,e.data.initialUpdates)&&this.downloadDocument(new URL(e.data.file,t.app).href,e.data.treeVersion)}handleTreeUpdate(e){this.treeSync.waitingForTree?this.remoteTreeUpdates.push(e):(this.treeSync.handleRemoteUpdate(e),this.emit("update",this.treeSync.tree))}downloadDocument(e,t){a(this.treeSync.waitingForTree,"Must be waiting for tree"),this.documentLoader&&(this.documentLoader.scheduler.cancel(),this.documentLoader.removeAllListeners());let n={partialParsing:!0,loadInBackground:!0,async refreshAccessToken(r){return{...r,credentials:"include"}}},s=new M(t,e,n);this.documentLoader=s,s.on("loadedFirstData",r=>{r.setService("metadata",{projectId:this.projectId}),s.pauseLoadingScopes();let c={isLoading:!0};this.treeSync.setTree(r,t,c);for(let d of this.remoteTreeUpdates)this.treeSync.handleRemoteUpdate(d);this.remoteTreeUpdates.length=0,this.emit("update",this.treeSync.tree),s.canvasTreeVersion<h&&this.emit("disconnect","ClientTooNew"),s.canvasTreeVersion>h&&this.emit("disconnect","ClientNeedsUpdate")}),s.on("loadedAllData",()=>{this.treeSync.loadedAllScopes(),this.emit("update",this.treeSync.tree)}),s.on("loadedScope",r=>{this.treeSync.loadOneScope(r,!1),this.emit("update",this.treeSync.tree)}),s.start().catch(p)}};var N=g("remote:project"),V=class{constructor(i,e,t){this.timeline=i;this.userId=e;this.projectId=t;o(this,"connection");o(this,"document");o(this,"api");o(this,"modulesAPI");o(this,"assetService");o(this,"reconnectTimeout");o(this,"shouldReconnect",!0);this.connection=new f(this.projectId),this.document=new S(this.timeline,this.projectId),this.api=new E(this.connection,this.projectId),this.assetService=new y(this.api),this.modulesAPI=new C(this.api,this.connection),this.connection.on("disconnect",this.onDisconnect,this),this.connection.on("message",this.onMessage,this),this.assetService.refresh().catch(p)}connect(){let i=this.document.treeSync.treeVersion;this.connection.connect(i),this.timeline.setOnline(!0),this.shouldReconnect=!0}disconnect(){this.shouldReconnect=!1,this.cancelReconnect(),this.connection.disconnect(),this.timeline.setOnline(!1)}maybeSend(){let i=this.document.treeSync,e=i.createUpdateToSend(),t=i.localUpdatesInFlight.length;e&&(N.debug("sending update:",t,e.changes.length,e.reasons),this.connection.send({type:"treeUpdate",value:b({...e,appEnvironment:"on_page"})}),I("editor_bar_interaction",{page:"editor-bar-project-page",id:"editor-bar-tree-update"}))}cancelReconnect(){clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0}scheduleReconnect(i){this.cancelReconnect(),this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this.connect()},i)}onDisconnect(i){if(this.shouldReconnect&&D(i)){let e=Q(i);this.scheduleReconnect(e)}}onMessage(i){switch(i.type){case"treeMessage":return this.document.handleTreeMessage(i.value);case"treeUpdate":return this.document.handleTreeUpdate(i.value);case"notifyProjectChange":switch(i.value.scope){case"assets":return this.assetService.refresh();case"assetsInvalidated":return this.assetService.refreshFully();default:return}}}};function Q(l){return l==="ReconnectToNewServer"?25:1e3}export{V as a};
//# sourceMappingURL=https://app.framerstatic.com/chunk-QBY2M5HG.mjs.map
